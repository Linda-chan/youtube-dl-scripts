<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN"
                      "http://www.w3c.org/TR/REC-html40/strict.dtd">
<html lang="ru">
  <head>
    <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
    <meta content="Линда Кайе. Посвящается Ариэль" name="Author">
    <meta content="AJPapps - Spawn HTML file" name="Generator">
    <meta content="ANPFile" name="ProgId">
    <meta content="width=device-width, initial-scale=1" name="Viewport">
    <meta content="---" name="Description">
    
    <title>youtube-dl Scripts</title>
    
    <style type="text/css">
    <!--
      body {
        font:12pt "Trebuchet MS",Tahoma,Arial,sans-serif;
      }
      pre, code {
        font:12pt Consolas,"Courier New",monospace;
      }
      pre {
        margin-left:20px;
      }
      img {
        border:none;
      }
    -->
    </style>
  </head>
  <body>
    
<h1 id="youtube-dl-scripts">youtube-dl Scripts</h1>

<p>Эти скрипты предназначены для запуска <a href="http://youtube-dl.org">youtube-dl</a> с некоторыми полезными параметрами. Разделение идёт по качеству запрашиваемого видео и использованию прокси.</p>

<p>Так же доступны варианты скриптов для форков программы <a href="https://github.com/yt-dlp/yt-dlp">yt-dlp</a> и <a href="https://github.com/ytdl-patched/ytdl-patched">ytdl-patched</a>. По большей части они идентичны оригинальным скриптам и добавляют разве что новый функционал, которого не было в youtube-dl. Поэтому дальше все версии программы будут называться одним словом – «youtube-dl».</p>

<h2 id="section">Отличия платформ</h2>

<p>Все скрипты представлены в двух версиях: BAT файлы для Windows и скрипты для Bash (Linux и тому подобное). В основном они идентичны, но Windows версия больше ориентирована на портабельность.</p>

<h3 id="windows">Windows</h3>

<ul>
  <li>
    <p>Рабочим каталогом считается каталог, в котором расположен запускаемый BAT файл. Текущий каталог  может совпадать с рабочим, но это не одно и то же.</p>
  </li>
  <li>
    <p>Ищет исполняемый файл youtube-dl в рабочем каталоге.</p>
  </li>
  <li>
    <p>Ищет <a href="https://ffmpeg.zeranoe.com/builds/win32/static/">ffmpeg</a> в подкаталоге «ffmpeg\bin» рабочего каталога.</p>
  </li>
  <li>
    <p>Ищет <a href="http://atomicparsley.sourceforge.net">AtomicParsley</a> в подкаталоге «AtomicParsley» рабочего каталога.</p>
  </li>
</ul>

<p>Если ffmpeg и/или AtomicParsley уже установлены в системе, и их каталоги присутствуют в PATH, то это тоже должно работать.</p>

<h3 id="bash">Bash</h3>

<ul>
  <li>
    <p>Рабочим каталогом считается текущий каталог. Этот каталог может не совпадать с с каталогом, в котором лежат sh файлы.</p>
  </li>
  <li>
    <p>Считает, что исполняемый файл youtube-dl установлен где-то в системе (например, в «/usr/local/bin» или куда его запихнёт пакетный менеджер).</p>
  </li>
  <li>
    <p>Считает, что ffmpeg установлен в системе.</p>
  </li>
  <li>
    <p>Считает, что AtomicParsley установлен где-то в системе.</p>
  </li>
</ul>

<h2 id="section-1">Каталоги и файлы</h2>

<p>При запуске скрипта (и на время его выполнения) переменная HOME переписывается рабочим каталогом. Таким образом все дополнительные файлы и каталоги будут искаться в нём.</p>

<h3 id="cache">.cache</h3>

<p>Этот каталог создаётся автоматически в рабочем каталоге для хранения неких данных, обычно прилетаемых с YouTube. Для этого на время работы скриптов переписывается переменная XDG_CACHE_HOME.</p>

<h3 id="section-2">Пользовательский конфиг</h3>

<p>При запуске скрипт ищет файл «youtube-dl.cfg» в рабочем каталоге. Если такой файл обнаруживается, он назначается конфигом для youtube-dl. Из него программа берёт дополнительные параметры как если бы они были переданы через командную строку.</p>

<p>Например, его содержимое может быть таким:</p>

<pre><code>--write-description
--write-info-json
--write-annotations
</code></pre>

<p><a href="https://github.com/ytdl-org/youtube-dl#configuration">Ещё больше примеров</a>.</p>

<h3 id="netrc">.netrc</h3>

<p>Данный файл содержит логины и пароли для сервисов и используется youtube-dl для аутентификации при скачивании. Ищется он тоже в рабочем каталоге.</p>

<p><a href="https://github.com/ytdl-org/youtube-dl#authentication-with-netrc-file">Документация по данному файлу</a>.</p>

<h3 id="cookiestxt">cookies.txt</h3>

<p>Альтернативный метод аутентификации – использование файла «cookies.txt», расположенного в рабочем каталоге. Содержимое – экспортированные куки из броузера, в котором уже выполнен вход на интересующие сервисы.</p>

<p><a href="https://github.com/ytdl-org/youtube-dl#how-do-i-pass-cookies-to-youtube-dl">Документация по данному файлу</a>, а так же по тому, как получить этот файл. Обратите внимание на описание формата файла, особенно – символы переноса строк.</p>

<h2 id="section-3">Прокси</h2>

<p>Настройки прокси берутся из системы. В Windows это – настройки Internet Explorer («Свойства обозревателя» или что-то такое в Панели управления), в Linux – переменная HTTP_PROXY (и сопутствующие). Если в системе прокси не определён, то соединение производится напрямую.</p>

<p>Так же прокси можно указать в пользовательском конфиге, используя ключ «&#8211;proxy».</p>

<p>Так же каждый скрипт имеет версию, которая принудительно отключает использование прокси.</p>

<h2 id="section-4">Формат имени файла скрипта</h2>

<p>Имя файла скрипта выглядит примерно так:</p>

<pre><code>youtube-dl-XX-YY.ZZ
</code></pre>

<p>Где:</p>

<ul>
  <li>
    <p>XX – вариант прокси:</p>

    <ul>
      <li><strong>np</strong> – прямое соединение.</li>
      <li><strong>prx</strong> – системный прокси.</li>
    </ul>
  </li>
  <li>
    <p>YY – качество видео, можно воспринимать как «степень сжатия» (подробности – ниже):</p>

    <ul>
      <li><strong>c0</strong> – лучшее.</li>
      <li><strong>c1</strong> – похуже.</li>
      <li><strong>c5</strong> – среднее.</li>
      <li><strong>c9</strong> – худшее.</li>
      <li><strong>cZ</strong> – определяется пользователем.</li>
      <li><strong>audio</strong> – извлечение аудио. Программа попытается скачать аудиофайл лучшего качества, а если это не получится, то видеофайл со звуковой дорожкой лучшего качества. В итоговый файл данные конвертируются при помощи ffmpeg. Если он отсутствует, программа оставит то, что прислал сервер.</li>
      <li><strong>formats</strong> – такой вариант скрипта просто показывает список доступных для скачки форматов, ничего не качая.</li>
      <li><strong>update</strong> – особый случай. Этот файл ничего не качает, а просто пытается обновить youtube-dl до последней версии и создаёт файл youtube-dl.txt со справкой по параметрам программы.</li>
      <li><strong>save-info</strong> – ещё один особый случай. Этот файл тоже ничего не качает, а сохраняет информацию о текущей версии в файл «youtube-dl-info.txt». Туда попадают юзерагент, который уходит на сервер, и все реализованные экстракторы.</li>
    </ul>
  </li>
  <li>
    <p>ZZ – расширение:</p>

    <ul>
      <li><strong>bat</strong> – Windows BAT файл.</li>
      <li><strong>sh</strong> – Bash скрипт.</li>
    </ul>
  </li>
</ul>

<p>Например:</p>

<pre><code>youtube-dl-prx-c9.bat
</code></pre>

<p>Это – BAT файл для Windows, качающий видео худшего качества через прокси.</p>

<h2 id="section-5">Качество видео</h2>

<h3 id="c0">c0</h3>

<p>В этом режиме качество не указывается совсем, и youtube-dl собирает видео из лучших форматов (например, HD видео без звука и HD аудио без изображения), а не выбирает уже готовый формат. Для его работы скорее всего понадобится ffmpeg.</p>

<h3 id="c1">c1</h3>

<p>youtube-dl автоматически выбирает лучшее качество из того, что предложит сервер.</p>

<p>Этот вариант может уступать варианту c0, поскольку выбирает готовый формат, а не собирает результат по кускам. Например, на YouTube часто бывает ситуация, когда HD видео присутствует отдельным форматом без звука (а HD звук – без видео), зато формат со звуком и видео имеет более низкое разрешение и качество звука похуже.</p>

<p>В предыдущих версиях скрипта этот режим назывался «c0».</p>

<h3 id="c5">c5</h3>

<p>Этот вариант основывается на предположении, что видео среднего качества имеет разрешение 360 пикселей по вертикали. Таким образом скрипт запрашивает не определённое качество (лучшее/худшее), а формат 360p или меньше, если такого нет.</p>

<p>В предыдущих версиях скрипта в этом варианте запрашивался формат Webm, который, как правило, содержал видео в 360p. Так же этот вариант работал только на YouTube. Но из-за каких-то изменений на самом YouTube, формат Webm теперь может содержать лучшее качество для некоторых видеороликов. Поэтому теперь скрипт ориентируется не на формат, а на максимальное разрешение. Возможно, теперь он будет полезен и на других видеосервисах.</p>

<h3 id="c9">c9</h3>

<p>youtube-dl автоматически выбирает худшее качество из того, что предложит сервер. На YouTube обычно это – 3gp (для старых мобильных телефонов). На других серверах может быть по-разному.</p>

<p><strong>Внимание!</strong> На серверах, отличных от YouTube, худшего качества может не быть (ролик может быть в одном варианте вообще), и youtube-dl скачает то, что есть. Тем, что есть может оказаться то же видео в HD качестве.</p>

<p>Так же на серверах отличных от YouTube худшее качество может быть в том же формате, что и лучшее, например, в MP4. Поэтому файлы обоих вариантов будут иметь одинаковое имя.</p>

<p>Будьте бдительны!</p>

<h3 id="cz">cZ</h3>

<p>В этом варианте формат видео выбирает сам пользователь. Его нужно передать первым аргументом скрипта в виде кода формата, который можно подсмотреть в первой колонке («Format code») таблички, которую показывает <strong>formats</strong> версия скриптов.</p>

<p>Так же можно указать общие значения, такие как «best», «worst», «mp4», «bestaudio/best» и так далее. Подробности смотрите в <a href="https://github.com/ytdl-org/youtube-dl#format-selection">документации</a> к youtube-dl, параметр «&#8211;format».</p>

<p>Указанный пользователем формат применяется ко всем URL в командной строке или файле списка. Если такого формата для очередного видео не окажется, youtube-dl пропустит его и перейдёт к следующему URL.</p>

<h2 id="description">Обновление описаний в Descript.ion</h2>

<p>Данные скрипты настроены на сохранение предпросмотров к видео в JPG файлах, а так же некоторых свойств видео в альтернативных потоках NTFS в Windows и расширенных атрибутах (xattr) в Linux. Одно из таких свойств имеет имя <strong>user.xdg.referrer.url</strong> и содержит URL исходного видео.</p>

<p>Я написала <a href="https://github.com/Linda-chan/xdgreferrer-to-description">скрипт</a> для Windows, который красиво извлекает эти адреса и записывает их в Descript.ion.</p>

<p>Проще всего его использовать через локальный конфиг (см. выше). Для этого в файл youtube-dl.cfg следует записать что-то вроде такого:</p>

<pre><code>--exec 'CScript.EXE //NoLogo "C:\Scripts\XdgReferrer To Description\XdgReferrerToDescription.WSF" /jpg {}'
</code></pre>

<p>Ключ «/jpg» сохранит описание и для файла предпросмотра, если такой будет.</p>

<h2 id="section-6">Скрипты для форков</h2>

<p>Как было сказано выше, имеются варианты скриптов для yt-dlp и ytdl-patched. Это форки оригинальной программы, которые появились из-за заморозки разработки оригинальной версии программы. Похоже, они обратно совместимы с youtube-dl, но привносят некоторые нововведения, из которых данные скрипты используют пока только сохранение разбивки видео на главы.</p>

<h3 id="yt-dlp">yt-dlp</h3>

<p>В Windows используется x64 екзешник программы – «yt-dlp.exe». При необходимости использования других вариантов (например, «yt-dlp_x86.exe») придётся править BAT файлы ручками. Или переименовывать екзешник, что может вызвать проблемы при обновлении и не рекомендуется.</p>

<p>Пользовательский конфиг этой версии называется «yt-dlp.cfg». Файл информации – «yt-dlp-info.txt».</p>

<h3 id="ytdl-patched">ytdl-patched</h3>

<p>В Windows используется екзешник программы с красной иконкой – «ytdl-patched-red.exe». При необходимости использования варианта с белой иконкой («ytdl-patched-white.exe») или любыми другими иконками, которые нарисует разработчик, придётся править BAT файлы ручками. Либо так же переименовывать екзешник с теми же проблемами.</p>

<p>Пользовательский конфиг этой версии называется «ytdl-patched.cfg». Файл информации – «ytdl-patched-info.txt».</p>

<h2 id="section-7">Разное</h2>

<h3 id="section-8">Параметры командной строки</h3>

<p>Скрипты работают вот по такому принципу:</p>

<ul>
  <li>
    <p>Конструируется командная строка, содержащая нужные нам опции, например, «&#8211;force-ipv4» и «&#8211;netrc».</p>
  </li>
  <li>
    <p>К ней добавляется командная строка, переданная скрипту. Обычно там URL.</p>
  </li>
  <li>
    <p>Екзешник или бинарник youtube-dl запускается с этой объединённой командной строкой.</p>
  </li>
</ul>

<p>Из вышесказанного вытекает то, что запускаемой программе можно передать не только URL, но и любые другие параметры, просто указав их в командной строке скрипта наряду с (или вместо) URL. Например:</p>

<pre><code>youtube-dl-prx-c0.bat --xattr-set-filesize URL
</code></pre>

<p>И это даже не требует модифицировать сами скрипты! Если же параметр приходится использовать слишком часто, всегда можно внести его в пользовательский конфиг.</p>

<p>Кстати, именно так работает передача скрипту файла списка адресов вместо самих адресов (что указано в подсказке по использованию). Параметр «-a» (а так же «&#8211;batch-file») – это параметр самого youtube-dl.</p>

<pre><code>youtube-dl-prx-c0.sh -a ~/todo.txt
</code></pre>

<h3 id="twitter">Twitter</h3>

<p>При скачке видео из Твиттера, youtube-dl использует текст поста в качестве имени файла. В последнее время в эти самые посты в невероятных количествах набивают всякий мусор вроде эмодзи, в результате чего файлы либо не сохраняются, либо потом не открываются.</p>

<p>Чтобы бороться с этим, можно указать вот такой нехитрый формат для выходных файлов прямо в командной строке скрипта перед URL:</p>

<pre><code>-o "@%(uploader_id)s - [%(id)s].%(ext)s"
</code></pre>

<h3 id="bash-1">Беды с Bash</h3>

<p>Изменения с Bash версией скрипта были связаны с тем, что я не смогла в имеющемся способе работы скриптов побороть одну мерзкую особенность.</p>

<p>Допустим, в командной строке мне нужно указать имя файла пользовательского конфига. Это я делаю, собирая специальную переменную, ещё до вызова бинарника youtube-dl. Например, так:</p>

<pre><code>PARAMS="$PARAMS --config-location $MY_DP/youtube-dl.cfg"
</code></pre>

<p>MY_DP – это переменная с каталогом, в котором лежит выполняющийся скрипт.</p>

<p>Далее я запускаю бинарник youtube-dl как-то так:</p>

<pre><code>youtube-dl --proxy "" --format worst $PARAMS "$@"
</code></pre>

<p>Здесь сначала идут параметры, вписанные прямо в этой строке, потом разворачивается переменная, которую мы конструировали ранее, а затем – параметры, которые получил скрипт при запуске.</p>

<p>И вот, если полный путь к каталогу, в котором лежит скрипт, будет пробел или что-то ещё такое, то youtube-dl получит неправильные аргументы и сломается.</p>

<p>Разумеется, имена файлов нужно передавать в кавычках, но&#8230; Но это не работает. По какой-то причине бинарник получает не то, что должно, и, соответственно, такие варианты не работают:</p>

<pre><code>PARAMS="$PARAMS --config-location '$MY_DP/youtube-dl.cfg'"
PARAMS="$PARAMS --config-location \"$MY_DP/youtube-dl.cfg\""
PARAMS='$PARAMS --config-location "$MY_DP/youtube-dl.cfg"'
</code></pre>

<p>Более того, я пыталась экранировать имя файла через find (с параметром «&#8211;printf»), но и там ничего не сработало.</p>

<p>Казалось бы, нужно просто указать имя файла при запуске бинарника, а не при конструировании переменной, и всё. Однако файл должен существовать, иначе случится ошибка при работе самого youtube-dl.</p>

<p>До данных изменений я делала это как-то так:</p>

<pre><code>if [[ -e "$MY_DP/youtube-dl.cfg" ]] ; then
  youtube-dl $PARAMS --config-location "$MY_DP/youtube-dl.cfg" "$@"
else
  youtube-dl $PARAMS "$@"
fi
</code></pre>

<p>Но с появлением «cookies.txt», который тоже должен существовать, мне пришлось бы сделать лесенку. А если бы появился ещё какой-то файл в будущем, лесенка сильно усложнилась бы.</p>

<p>Поэтому я сдалась и сделала так, чтобы рабочим каталогом был текущий каталог, что на самом деле очень плохо, но позволяет делать так:</p>

<pre><code>PARAMS="$PARAMS --config-location ./youtube-dl.cfg"
</code></pre>

<p>Живите теперь с этим.</p>

<h2 id="section-9">История изменений</h2>

<ul>
  <li>
    <p>23.07.2017</p>

    <ul>
      <li>[+] В подсказку по использованию добавлен пример с ключами «-a» и «&#8211;batch-file». Сама поддержка уже была в скриптах по причине передачи всех параметров BAT и sh файлов программе.</li>
      <li>[+] Теперь появился нормальный ченджлог. Предыдущие изменения можно выяснить разве что только из истории коммитов.</li>
    </ul>
  </li>
  <li>
    <p>27.08.2017</p>

    <ul>
      <li>[+] Появилась поддержка пользовательского конфига в Windows.</li>
    </ul>
  </li>
  <li>
    <p>24.06.2018</p>

    <ul>
      <li>[-] Пофиксила уйму кавычек в sh файлах.</li>
      <li>[+] Появилась поддержка пользовательского конфига в Linux.</li>
      <li>[-] При отсутствии файла .netrc, больше не ругаются ни Bash, ни youtube-dl.</li>
    </ul>
  </li>
  <li>
    <p>23.08.2018</p>

    <ul>
      <li>[+] с5 версия скриптов теперь запрашивает не Webm, а 360p.</li>
    </ul>
  </li>
  <li>
    <p>26.02.2023</p>

    <ul>
      <li>[+] Появились варианты скриптов для yt-dlp и ytdl-patched.</li>
      <li>[+] Изменился смысл с0 версии скриптов.</li>
      <li>[+] Старые с0 версии скриптов переименованы в c1.</li>
    </ul>
  </li>
  <li>
    <p>13.05.2023</p>

    <ul>
      <li>[+] Добавлена поддержка файлов cookies.txt.</li>
      <li>[+] Подсказка по использованию теперь чуть компактнее.</li>
      <li>[+] Подсказка по использованию в Bash версии теперь выводит имя файла скрипта без каталога.</li>
      <li>[+] В BAT версии немного оптимизированы переменные типа «%~dp0». Раньше использовалась запись вида «%~d0%~p0».</li>
      <li>[+] Bash скрипты теперь не пытаются получить свой каталог, а считают рабочим каталогом текущий. Попутно былые проблемы с симлинками должны исчезнуть.</li>
      <li>[+] Метод combo сто лет не использовался, и я просто выкинула соответствующие скрипты.</li>
      <li>[+] Обновила документацию.</li>
    </ul>
  </li>
</ul>

<h2 id="section-10">Маленький копирайт</h2>

<ol>
  <li>
    <p>Программа и исходный код распространяются бесплатно.</p>
  </li>
  <li>
    <p>Вы имеете право распространять их на тех же условиях.</p>
  </li>
  <li>
    <p>Вы не имеете права использовать имя автора после модификации исходного кода.</p>
  </li>
  <li>
    <p>При этом желательно указывать ссылку на автора оригинальной версии исходного кода.</p>
  </li>
  <li>
    <p>Вы не имеете права на платное распространение исходного кода, а также программных модулей, содержащих данный исходнй код.</p>
  </li>
  <li>
    <p>Программа и исходный код распространяются как есть. Автор не несёт ответственности за любые трагедии или несчастные случаи, вызванные использованием программы и исходного кода.</p>
  </li>
  <li>
    <p>Для любого пункта данного соглашения может быть сделано исключение с разрешения автора программы.</p>
  </li>
  <li>
    <p>По любым вопросам, связанным с данной программой, обращайтесь по адресу lindaoneesama@gmail.com</p>
  </li>
</ol>

    
  </body>
</html>
